name: RDP Connection

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
    - name: Configure RDP
      run: |
        Write-Host "Configurando RDP..."
        # Habilitar Escritorio Remoto
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        # Configurar autenticación
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        # Configurar firewall
        netsh advfirewall firewall add rule name="Open RDP Port" dir=in action=allow protocol=TCP localport=3389
        # Reiniciar servicio
        Restart-Service -Name "TermService" -Force
        Write-Host "RDP configurado correctamente"

    - name: Create User
      run: |
        Write-Host "Creando usuario RDP..."
        $password = "12345678"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        # Crear usuario
        New-LocalUser -Name "RDPUser" -Password $securePassword -AccountNeverExpires
        # Agregar a grupos administrativos
        Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
        Write-Host "Usuario creado: RDPUser / 12345678"

    - name: Get IP Address
      run: |
        Write-Host "Obteniendo dirección IP..."
        $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
        Write-Host "IP de la máquina: $ip"
        echo "IP_ADDRESS=$ip" >> $env:GITHUB_ENV

    - name: Display Connection Info
      run: |
        Write-Host "=========================================="
        Write-Host "         INFORMACIÓN DE CONEXIÓN RDP"
        Write-Host "=========================================="
        Write-Host "DIRECCIÓN: $env:IP_ADDRESS"
        Write-Host "USUARIO: RDPUser"
        Write-Host "CONTRASEÑA: 12345678"
        Write-Host "PUERTO: 3389"
        Write-Host "=========================================="
        Write-Host "INSTRUCCIONES:"
        Write-Host "1. Abre 'Conexión a Escritorio Remoto'"
        Write-Host "2. Ingresa la dirección IP mostrada arriba"
        Write-Host "3. Usuario: RDPUser"
        Write-Host "4. Contraseña: 12345678"
        Write-Host "=========================================="

    - name: Wait for 20 minutes
      run: |
        $startTime = Get-Date
        $endTime = $startTime.AddMinutes(20)
        Write-Host "Manteniendo conexión activa por 20 minutos..."
        
        while ((Get-Date) -lt $endTime) {
            $currentTime = Get-Date
            $elapsed = $currentTime - $startTime
            $remaining = $endTime - $currentTime
            
            Write-Host "Tiempo transcurrido: $([int]$elapsed.TotalMinutes)m $([int]$elapsed.Seconds)s - Restante: $([int]$remaining.TotalMinutes)m $([int]$remaining.Seconds)s"
            Start-Sleep -Seconds 30
        }
        
        Write-Host "Tiempo completado. Cerrando conexión..."
